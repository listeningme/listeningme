<!DOCTYPE html>
<html ng-app="turquoiseapp">
  <% include head %>
  <body>
    <% include header %>  
    <div ui-view></div> 
    <div id="moverightFr" ng-class="aaa? 'animated bounceInRight modelsdiv' : 'moverightFr'" ng-controller="likelistCtrl">
      <div class="mouserightFr" style="width:60px;height:100px;background:#333;">
        <ul  ng-click="aaa =!aaa" style="z-index:9999">
          <li>喜</li><li>
          </li><li>好</li><li>
          </li><li>清</li><li>
          </li><li>單</li><li>
        </li></ul>
      </div>
      <div class="rightFr">
        <ul style="padding:10px;">
          <li><h3>喜歡搜尋結果清單</h3></li>
          <li>
            <ul>
              <li>
                <a ng-repeat="ki in likesearchshow" ng-click="sendthisselected(ki.content)">{{ki.content}}</a>
              </li>
            <ul>
          </li>
          <br/><br/>
          <li><h3>喜歡法條清單</h3></li>
          <li>
            <ul>
              <li ng-repeat="i in likelistshow"><a href="/#/details/{{i._id}}" style="cursor:pointer">{{i.title}}</a></li>
            </ul>  
          </li>

        </ul>
        

      </div>
    </div>
    <!-- Also a way to navigate -->
    <script type="text/javascript">
      
      var myapp = angular.module('turquoiseapp', ['ui.state','ngStorage','ui.bootstrap']) ;
      var _str_type;
      myapp.factory('search_zh',function(){
        return _str_type;
      })
      // 喜歡列表清單-------------------------------------------------  
      myapp.controller('likelistCtrl',function($scope,$localStorage,search_zh){
          $scope.$storage = $localStorage.$default({
              likelawlist: [],
              likesearchlist:[]
          });
          $scope.likelistshow = $scope.$storage.likelawlist;
          $scope.likesearchshow = $scope.$storage.likesearchlist;
          $scope.sendthisselected = function (content){
            //這邊要做顛選擇條過去搜尋
          }
      })
      //-----------------------------------------------------------
      myapp.config(function($stateProvider, $urlRouterProvider,$routeProvider){
      // For any unmatched url, send to /route1
      $urlRouterProvider.otherwise("/index");
      // Now set up the states
      //console.log($routeProvider);
      $stateProvider
        .state('index', {
            url: "/index",
            // url: "/route1/{contactId:[0-9]{1,8}}",
            templateUrl: "/themeplate/index.ejs",
            factory:'search_zh',
            controller:function ($scope,$stateParams,$http,$location,$localStorage){
              $scope.$storage = $localStorage;
              $scope.likethislaw =function (id,title){
                var _arrtmp = {title:title,_id:id};
                $scope.$storage.likelawlist.push(_arrtmp);
                //console.log($scope.$storage.likelawlist);
              }
              $http.get('/indexlaws?location=TPE').success(function (data) {
                  $scope.datas = data;
                  var _tmp_nt=0,_tmp_ft=[],_tmp_bf=[],_tmp_mc=[],_tmp_fw=[],_tmp_cc=[];
                  angular.forEach(data, function(v, k){
                    if (v.max_type == 'NT.'){
                      if(v.max_content!= undefined){
                        _tmp_nt =_tmp_nt+Number(v.max_content);
                      } 
                    }
                    if (v.max_type == '輔具'){
                      if(v.max_content!= undefined){
                        _tmp_ft.push(v.max_content); 
                      }
                    }
                    if (v.max_type == '辦法'){
                      if(v.max_content!= undefined){
                        _tmp_bf.push(v.max_content);  
                      }
                      //console.log(_tmp_bf);
                    }
                    if (v.max_type == '名冊'){
                      if(v.max_content!= undefined){
                          _tmp_mc.push(v.max_content);
                      }
                    }
                    if (v.max_type == '服務'){
                      if(v.max_content!= undefined){
                          _tmp_fw.push(v.max_content);
                      }
                    }
                    if (v.max_type == '證件'){
                      if(v.max_content!= undefined){
                          _tmp_cc.push(v.max_content);
                      }
                    }
                  });
                  $scope._tmp_nt= _tmp_nt;
                  $scope._tmp_ft= _tmp_ft;
                  $scope._tmp_bf= _tmp_bf;
                  $scope._tmp_mc= _tmp_mc;
                  $scope._tmp_fw= _tmp_fw;
                  $scope._tmp_cc= _tmp_cc;
              });
              $http.get('/get/location').success(function (data) {
                  $scope.lodatas = data;
              });
              $scope.clicksearch = function (){
                $scope.searchblank = true;
              }
              $scope.selected = undefined;
              $http.get('/bk/getAllFirstTag').success(function (data) {
                  $scope.allTagdatas = data;
                  var firsttagArr = [];
                  angular.forEach(data, function(v, k){
                    firsttagArr.push(v.name_zh)
                  });
                  $scope.states = firsttagArr;
              });
              $scope.goSearchArrTag = []; //（搜尋用）專門放第一階段tag Arr
              $scope.goSearchArrGeneral = []; //（搜尋用）專門放使用者自己的關鍵字 Arr
              $scope.goSearchArrLocation = []; //（搜尋用）專門放使用者欲查詢地區 Arr
              //（待做）偵測使用者目前所在地區-------------------------------------
              $scope.location = 'TPE';
              $scope.goSearchArrLocation.push($scope.location);
              //--------------------------------------------------------------
              $scope.gosearch =function(){
                  search_zh = $scope.selected
                  //console.log(search_zh);
                  var _sresault = $scope.selected.split(' ');
                  var _tmpArr = [];
                  angular.forEach($scope.allTagdatas, function(v, k){
                      angular.forEach(_sresault, function(v1, k1){
                         if(v.name_zh == v1){
                            $scope.goSearchArrTag.push(v.name_en);
                            _tmpArr.push(v.name_zh);
                            //console.log($scope.goSearchArrTag)
                           // _ck = 1;
                         }
                     });
                  });  
                  angular.forEach(_tmpArr, function(v1, k1){
                       removeA(_sresault, v1);
                  });
                  //抓到要general的搜尋
                  var _gen = _sresault.toString();
                  var _tag = $scope.goSearchArrTag.toString();
                  if(_tag == ''){
                    _tag = null
                  }
                  if(_gen == ''){
                    _gen = null
                  }
                  $location.path('/search/').search({general:_gen,location:$scope.goSearchArrLocation[0],tag:_tag});
              }
              $scope.changelocation = function(t){
                  $scope.goSearchArrLocation.length = 0;
                  $scope.goSearchArrLocation.push(t);
                  if($scope.selected == undefined){
                    $http.get('indexlaws?location='+$scope.goSearchArrLocation[0]).success(function (data) {
                         $scope.datas = data;
                         var _tmp_nt=0,_tmp_ft=[],_tmp_bf=[],_tmp_mc=[],_tmp_fw=[],_tmp_cc=[];
                          angular.forEach(data, function(v, k){
                            if (v.max_type == 'NT.'){
                              if(v.max_content!= undefined){
                                _tmp_nt =_tmp_nt+Number(v.max_content);
                              } 
                            }
                            if (v.max_type == '輔具'){
                              if(v.max_content!= undefined){
                                _tmp_ft.push(v.max_content); 
                              }
                            }
                            if (v.max_type == '辦法'){
                              if(v.max_content!= undefined){
                                _tmp_bf.push(v.max_content);  
                              }
                              //console.log(_tmp_bf);
                            }
                            if (v.max_type == '名冊'){
                              if(v.max_content!= undefined){
                                  _tmp_mc.push(v.max_content);
                              }
                            }
                            if (v.max_type == '服務'){
                              if(v.max_content!= undefined){
                                  _tmp_fw.push(v.max_content);
                              }
                            }
                            if (v.max_type == '證件'){
                              if(v.max_content!= undefined){
                                  _tmp_cc.push(v.max_content);
                              }
                            }
                          });
                          $scope._tmp_nt= _tmp_nt;
                          $scope._tmp_ft= _tmp_ft;
                          $scope._tmp_bf= _tmp_bf;
                          $scope._tmp_mc= _tmp_mc;
                          $scope._tmp_fw= _tmp_fw;
                          $scope._tmp_cc= _tmp_cc;
                    });
                  }
                  //console.log($scope.goSearchArrLocation);
              }
              $scope.savethissearchtag = function(){
                  
                  var _arrtmp = {location:$scope.location,content:$scope.selected}
                  //console.log(_arrtmp);
                  $scope.$storage.likesearchlist.push(_arrtmp);
              }
            }
        })
        .state('help', {
            url: "/help",
            // url: "/route1/{contactId:[0-9]{1,8}}",
            templateUrl: "/themeplate/help.ejs",
            controller:function ($scope,$stateParams){
              console.log($stateParams.contactId);
            }
        })
        .state('newResp',{
           url: "/newResp",
            templateUrl: "/themeplate/newResp.ejs",
            controller:function ($scope,$stateParams){
              console.log($stateParams.resault);
            }
        })
        .state('details',{
           url: "/details/:id",
            templateUrl: "/themeplate/details.ejs",
            controller:function ($scope,$stateParams,$http){
              //console.log($stateParams.id);
              //var converter = new Showdown.converter();
              $http.get('/get/lawDetails?_id='+$stateParams.id).success(function (data) {
                  $scope.lawdatas = data;
                });
              $scope.senderrrequest = [{name_zh:'資料過期',name_en:'資料過期'},
                                {name_zh:'內容有誤',name_en:'內容有誤'},
                                {name_zh:'其他建議',name_en:'其他建議'}];
              $scope.selerrfeedback =function (sel){
                if(sel == '內容有誤'){
                    $scope.err_content =  $scope.lawdatas[0].content;
                }else{
                    $scope.err_content = '';
                }
              }
              $scope.senderrdata = function (){
                $http({
                    url:'/sendLawErrFeedback',
                    method:'POST',
                    data:{
                      lawid:$scope.lawdatas[0]._id,
                      type_sel:$scope.senderrrequestsel,
                      content:$scope.err_content,
                      email:$scope.email
                    },
                    }).success(function (data, status, headers, config) {
                      if(data == 'success'){
                        alert('感謝您的回饋，已傳送成功！')
                        $scope.poperrorrequest=!$scope.poperrorrequest;
                        $scope.senderrrequestsel = '';
                        $scope.err_content = '';
                        $scope.email = '';
                      }
                });
                
              }
            }
        })
        .state('aboutus',{
           url: "/aboutus",
            templateUrl: "/themeplate/header/aboutus.ejs",
            controller:function ($scope,$stateParams){
              console.log($stateParams.resault);
            }
        })
        .state('search',{
           url: "/search/?general&tag&location",
            templateUrl: "/themeplate/index.ejs",
            factory:'search_zh',
            controller:function ($scope,$stateParams,$http,$location,$localStorage){
              $scope.$storage = $localStorage;
              $scope.likethislaw =function (id,title){
                var _arrtmp = {title:title,_id:id};
                $scope.$storage.likelawlist.push(_arrtmp);
                //console.log($scope.$storage.likelawlist);
              }
              
              $http.get('/bk/getAllFirstTag').success(function (data) {
                  $scope.allTagdatas = data;
                  var firsttagArr = [];
                  angular.forEach(data, function(v, k){
                    firsttagArr.push(v.name_zh)
                  });
                  $scope.states = firsttagArr;
                  //parse初始網址--------------------------------
                  var _tmpstring = '';                   
                  if($stateParams.general != 'null'){
                      var _init_general = $stateParams.general.split(',');
                  }
                 // console.log(data);
                  if($stateParams.tag != 'null'){
                      var _init_tag_tmp = $stateParams.tag.split(',');
                  }
                 // console.log(_init_tag_tmp);
                  var _init_tag = [];
                  if($stateParams.tag != 'null'){
                    angular.forEach(_init_tag_tmp, function(v, k){
                      angular.forEach(data, function(v1, k1){
                           if(v1.name_en == v){
                              _init_tag.push(v1.name_zh);
                           }
                      });
                    });
                  }
                  //console.log(_init_tag);
                  var _init_tmp = [];
                  if($stateParams.general != 'null'){
                      angular.forEach(_init_general, function(v, k){
                        _init_tmp.push(v);
                      });
                  }
                  if($stateParams.tag != 'null'){
                      angular.forEach(_init_tag, function(v, k){
                        _init_tmp.push(v);
                      });
                  }

                  var _init_searchresault = '';
                  angular.forEach(_init_tmp, function(v, k){
                     _init_searchresault += v+' ';
                  });
                  $scope.selected = _init_searchresault;

                  // -------------------------------------------
              });
              $scope.searchblank = true;
              $http.get('/get/location').success(function (data) {
                  $scope.lodatas = data;
              });
              $http.get('/search?general='+$stateParams.general+'&location='+$stateParams.location+'&tag='+$stateParams.tag).success(function (data) { 
                  if(data=='none'){
                    $scope.noneresult = true;
                  }
                  $scope.datas =data;
                  var _tmp_nt=0,_tmp_ft=[],_tmp_bf=[],_tmp_mc=[],_tmp_fw=[],_tmp_cc=[];
                  angular.forEach(data, function(v, k){
                    if (v.max_type == 'NT.'){
                      if(v.max_content!= undefined){
                        _tmp_nt =_tmp_nt+Number(v.max_content);
                      } 
                    }
                    if (v.max_type == '輔具'){
                      if(v.max_content!= undefined){
                        _tmp_ft.push(v.max_content); 
                      }
                    }
                    if (v.max_type == '辦法'){
                      if(v.max_content!= undefined){
                        _tmp_bf.push(v.max_content);  
                      }
                      //console.log(_tmp_bf);
                    }
                    if (v.max_type == '名冊'){
                      if(v.max_content!= undefined){
                          _tmp_mc.push(v.max_content);
                      }
                    }
                    if (v.max_type == '服務'){
                      if(v.max_content!= undefined){
                          _tmp_fw.push(v.max_content);
                      }
                    }
                    if (v.max_type == '證件'){
                      if(v.max_content!= undefined){
                          _tmp_cc.push(v.max_content);
                      }
                    }
                  });
                  $scope._tmp_nt= _tmp_nt;
                  $scope._tmp_ft= _tmp_ft;
                  $scope._tmp_bf= _tmp_bf;
                  $scope._tmp_mc= _tmp_mc;
                  $scope._tmp_fw= _tmp_fw;
                  $scope._tmp_cc= _tmp_cc;
                });
              $http.get('/bk/getAllFirstTag').success(function (data) {
                  $scope.allTagdatas = data;
                  var firsttagArr = [];
                  angular.forEach(data, function(v, k){
                    firsttagArr.push(v.name_zh)
                  });
                  $scope.states = firsttagArr;
              });
              $scope.goSearchArrTag = []; //（搜尋用）專門放第一階段tag Arr
              $scope.goSearchArrGeneral = []; //（搜尋用）專門放使用者自己的關鍵字 Arr
              $scope.goSearchArrLocation = []; //（搜尋用）專門放使用者欲查詢地區 Arr
              //（待做）偵測使用者目前所在地區-------------------------------------
              $scope.location = $stateParams.location;
              $scope.goSearchArrLocation.push($scope.location);
              if($stateParams.general != null){
                  var _general = $stateParams.general.split(",");
                  angular.forEach(_general, function(v, k){
                     $scope.goSearchArrGeneral.push(v);
                   });  
              }
              if($stateParams.tag != null){
                  var _ta = $stateParams.tag.split(",");
                  angular.forEach(_ta, function(v, k){
                     $scope.goSearchArrTag.push(v);
                  });  
              }
              // console.log($scope.goSearchArrGeneral);
              // console.log($scope.goSearchArrTag);
              $scope.gosearch =function(){
                  search_zh = $scope.selected
                  var _sresault = $scope.selected.split(' ');
                  var _tmpArr = [];
                  angular.forEach($scope.allTagdatas, function(v, k){
                      angular.forEach(_sresault, function(v1, k1){
                         if(v.name_zh == v1){
                            $scope.goSearchArrTag.push(v.name_en);
                            _tmpArr.push(v.name_zh);
                            //console.log($scope.goSearchArrTag)
                           // _ck = 1;
                         }
                     });
                  });  
                  angular.forEach(_tmpArr, function(v1, k1){
                       removeA(_sresault, v1);
                  });
                  //抓到要general的搜尋
                  var _gen = _sresault.toString();
                  var _tag = $scope.goSearchArrTag.toString();
                  if(_tag == ''){
                    _tag = null
                  }
                  if(_gen == ''){
                    _gen = null
                  }
                  $location.path('/search/').search({general:_gen,location:$scope.goSearchArrLocation[0],tag:_tag});
              }
              $scope.changelocation = function(t){
                  $scope.goSearchArrLocation.length = 0;
                  $scope.goSearchArrLocation.push(t);

                  search_zh = $scope.selected
                  var _sresault = $scope.selected.split(' ');
                  var _tmpArr = [];
                  angular.forEach($scope.allTagdatas, function(v, k){
                      angular.forEach(_sresault, function(v1, k1){
                         if(v.name_zh == v1){
                            $scope.goSearchArrTag.push(v.name_en);
                            _tmpArr.push(v.name_zh);
                            //console.log($scope.goSearchArrTag)
                           // _ck = 1;
                         }
                     });
                  });  
                  angular.forEach(_tmpArr, function(v1, k1){
                       removeA(_sresault, v1);
                  });
                  //抓到要general的搜尋
                  var _gen = _sresault.toString();
                  var _tag = $scope.goSearchArrTag.toString();
                  if(_tag == ''){
                    _tag = null
                  }
                  if(_gen == ''){
                    _gen = null
                  }
                  $location.path('/search/').search({general:_gen,location:$scope.goSearchArrLocation[0],tag:_tag});

                  //console.log($scope.goSearchArrLocation);
              }

              //------------------------------------------
              //傳送查詢結果失敗的結果
              $scope.sendnoresault = function(){
                  $http({
                      url:'/noResaultFeedBack',
                      method: "POST",
                      data:{
                          goSearchArrTag:$scope.goSearchArrTag,
                          goSearchArrGeneral:$scope.goSearchArrGeneral,
                          goSearchArrLocation:$scope.goSearchArrLocation
                      }
                    }).success(function (data, status, headers, config) {
                        if(data == 'success'){
                          alert('已傳送!感謝您的回饋');  
                        }else{
                          alert('傳送失敗，再試一次!');
                        }
                    })
              }
              $scope.savethissearchtag = function(){
                  
                  var _arrtmp = {location:$scope.location,content:$scope.selected}
                  console.log(_arrtmp);
                  $scope.$storage.likesearchlist.push(_arrtmp);
              }

            }
        })
        .state('login',{
           url: "/login",
            templateUrl: "/themeplate/login/login.ejs",
            controller:function ($scope,$stateParams){
            }
        })
    })
    .run(['$rootScope', '$state', '$stateParams',
        function ($rootScope, $state, $stateParams) {
            $rootScope.$state = $state;
            $rootScope.$stateParams = $stateParams;
            //$templateCache.put('/themeplate/search_header.ejs')
    }]);
    myapp.directive("markdown", function ($compile, $http) {
        var converter = new Showdown.converter();
        return {
            restrict: 'E',
            replace: true,
            link: function (scope, element, attrs) {
                $http.get('/get/lawDetails?_id='+scope.$stateParams.id).success(function (data) {
                    element.html(converter.makeHtml(data[0].content));
                });
            }
        };
    });
    // myapp.directive('lsdiv',function(){
    //   return {
    //     link: function($scope, elem, iAttrs, controller) {
    //         elem.bind('click',function(){
    //           console.log(elem.parent().addClass('animated modelsdiv fadeInRight'))
    //           // elem.addClass('A');
    //         })
    //     }
    //   };
    // });
    //比較兩個array 去掉相同者
    function removeA(arr) {
        var what, a = arguments, L = a.length, ax;
        while (L > 1 && arr.length) {
            what = a[--L];
            while ((ax= arr.indexOf(what)) !== -1) {
                arr.splice(ax, 1);
            }
        }
        return arr;
    }
    </script>
    <% include footer %>
  </body>
</html>